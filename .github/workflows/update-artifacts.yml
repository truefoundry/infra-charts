name:  Update artifacts manifest

on:
  push:
    branches:
      -  main
      -  add-artifacts-template-generation

jobs:
    update-artifacts:
        runs-on: ubuntu-latest
        steps:
        - name: Checkout Code
          uses: actions/checkout@v3
          with:
            fetch-depth: 0

        - name: Setup Kubectl
          id: install-kubectl
          uses: azure/setup-kubectl@v3
          with:
            version: 'latest'

        - name: Setup Helm
          uses: azure/setup-helm@v4.2.0
          with:
            version: v3.15.1

        - uses: actions/setup-python@v5
          with:
            python-version: '3.10'

        - name: Install python dependencies
          run: pip install -r scripts/requirements.txt

          # get the latest version of the chart in charts/tfy-k8s-aws-eks-inframold/Chart.yaml
        - name: Get Chart Version
          id: get_chart_version
          run: echo ::set-output name=chart_version::$(cat charts/tfy-k8s-aws-eks-inframold/Chart.yaml | grep version | awk '{print $2}')

        # Get the list of charts ending with inframold
        - name: Get Charts List
          id: get_charts_list
          run: |
            echo "::set-output name=charts_list::$(ls charts | grep inframold)"


        - name: Generate Artifacts Manifest for Each Chart
          run: |
            for chart in ${{ steps.get_charts_list.outputs.charts_list }}; do
              version=$(cat charts/$chart/Chart.yaml | grep version | awk '{print $2}')
              python scripts/artifacts_template_generator.py $chart https://truefoundry.github.io/infra-charts/ \
                $version charts/$chart/values.yaml charts/$chart/artifacts-manifest.json scripts/extra.json
              ls -la charts/$chart
            done

