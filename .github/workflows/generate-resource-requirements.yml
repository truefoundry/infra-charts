name: Generate Resource Requirements

on:
  pull_request:
    branches:
      - 'main'
    paths:
      - '.github/workflows/generate-resource-requirements.yml'
      - '.github/control-plane/**'
      - 'charts/truefoundry/**'
      - 'charts/tfy-llm-gateway/**'
      - 'scripts/calculate-resources.py'

jobs:
  generate-resources:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Setup Helm
        uses: azure/setup-helm@v4.3.0
        with:
          version: v3.17.3

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Add Helm Repositories
        run: |
          helm repo add truefoundry https://truefoundry.github.io/infra-charts/
          helm repo update truefoundry

      - name: Update Helm Dependencies
        run: |
          helm dependency update charts/truefoundry
          helm dependency update charts/tfy-llm-gateway

      - name: Generate All Templates
        run: |
          mkdir -p output
          
          # Generate templates for all combinations
          for tier in small medium large; do
            echo "Generating templates for tier: $tier"
            
            # Control Plane Only
            helm template truefoundry charts/truefoundry \
              -f .github/control-plane/control-plane-only.yaml \
              --set global.resourceTier=$tier \
              > output/control-plane-only-$tier.yaml
            
            # Control Plane + Gateway
            helm template truefoundry charts/truefoundry \
              -f .github/control-plane/control-plane-gateway.yaml \
              --set global.resourceTier=$tier \
              > output/control-plane-gateway-$tier.yaml
            
            # Gateway Only
            helm template tfy-llm-gateway charts/tfy-llm-gateway \
              -f .github/control-plane/gateway.yaml \
              --set global.resourceTier=$tier \
              > output/gateway-only-$tier.yaml
          done

      - name: Generate Resource Requirements Section
        run: |
          # Generate the resource requirements content
          cat > resource-section.md << 'HEADER'
          ## Resource Requirements

          This section shows the resource requirements for different deployment configurations and resource tiers.

          - **small**: Suitable for development and testing environments
          - **medium**: Suitable for small production workloads
          - **large**: Suitable for production environments with higher traffic

          > **Note:** Values shown are totals (per-pod resources Ã— replica count).

          ### Control Plane Only

          Minimal control plane deployment without LLM Gateway components.

          HEADER
          
          for tier in small medium large; do
            TIER_UPPER=$(echo "$tier" | tr '[:lower:]' '[:upper:]')
            echo "#### $TIER_UPPER" >> resource-section.md
            echo "" >> resource-section.md
            python3 scripts/calculate-resources.py "output/control-plane-only-$tier.yaml" --markdown >> resource-section.md
            echo "" >> resource-section.md
          done
          
          # Control Plane with Gateway
          echo "### Control Plane with Gateway" >> resource-section.md
          echo "" >> resource-section.md
          echo "Full control plane deployment with LLM Gateway components enabled." >> resource-section.md
          echo "" >> resource-section.md
          
          for tier in small medium large; do
            TIER_UPPER=$(echo "$tier" | tr '[:lower:]' '[:upper:]')
            echo "#### $TIER_UPPER" >> resource-section.md
            echo "" >> resource-section.md
            python3 scripts/calculate-resources.py "output/control-plane-gateway-$tier.yaml" --markdown >> resource-section.md
            echo "" >> resource-section.md
          done
          
          # Gateway Only
          echo "### Gateway Only" >> resource-section.md
          echo "" >> resource-section.md
          echo "Standalone LLM Gateway deployment connecting to an external control plane." >> resource-section.md
          echo "" >> resource-section.md
          
          for tier in small medium large; do
            TIER_UPPER=$(echo "$tier" | tr '[:lower:]' '[:upper:]')
            echo "#### $TIER_UPPER" >> resource-section.md
            echo "" >> resource-section.md
            python3 scripts/calculate-resources.py "output/gateway-only-$tier.yaml" --markdown >> resource-section.md
            echo "" >> resource-section.md
          done

      - name: Update README
        run: |
          # Remove existing Resource Requirements section if it exists
          if grep -q "^## Resource Requirements" README.md; then
            # Use awk to remove from "## Resource Requirements" to the next "## " section or end of file
            awk '/^## Resource Requirements/{skip=1; next} /^## [^R]/{skip=0} !skip' README.md > README.tmp
            mv README.tmp README.md
          fi
          
          # Append the new resource section
          cat resource-section.md >> README.md

      - name: Commit & Push Updates
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "[CI] Update resource requirements in README" --signoff
            git pull origin --rebase
            git push
          fi
