{{- if .Values.karpenter.inferentiaProvisionerSpec.enabled }}
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: inferentia-nodepool
  namespace: karpenter
spec:
  weight: 10
  disruption:
  {{- if .Values.karpenter.inferentiaProvisionerSpec.consolidation.enabled }}
    consolidationPolicy: WhenUnderutilized
  {{- else }}
    expiresAfter: {{ .Values.karpenter.inferentiaProvisionerSpec.ttlSecondsAfterEmpty }}
  {{- end }}
  template:
    metadata:
      {{- if .Values.karpenter.inferentiaProvisionerSpec.labels }}
      labels:
        {{- .Values.karpenter.inferentiaProvisionerSpec.labels | toYaml | nindent 8 }}
      {{- end }}
  spec:
    requirements:
      - key: karpenter.sh/capacity-type
        operator: In
        values:
        {{- range .Values.karpenter.inferentiaProvisionerSpec.capacityTypes }}
          - {{ . | quote }}
        {{- end }}
      - key: topology.kubernetes.io/zone
        operator: In
        values:
        {{- range .Values.karpenter.inferentiaProvisionerSpec.zones  }}
          - {{ . | quote }}
        {{- end }}
      - key: kubernetes.io/arch
        operator: In
        values:
          - amd64
      - key: karpenter.k8s.aws/instance-family
        operator: In
        values:
        {{- range .Values.karpenter.inferentiaProvisionerSpec.instanceFamilies  }}
          - {{ . | quote }}
        {{- end }}
      - key: karpenter.k8s.aws/instance-size
        operator: NotIn
        values:
        {{- range .Values.karpenter.inferentiaProvisionerSpec.instanceSizes.notAllowed  }}
          - {{ . | quote }}
        {{- end }}
    taints:
      - key: "aws.amazon.com/neuron"
        effect: "NoSchedule"
    nodeClassRef:
      apiVersion: karpenter.k8s.aws/v1beta1
      kind: EC2NodeClass
      name: {{ .Values.karpenter.inferentiaProvisionerSpec.providerRefName }}
{{- end }}
