apiVersion: v1
kind: ConfigMap
metadata:
  name: tfy-otel-collector-config
  labels:
      {{- include "tfy-otel-collector.labels" . | nindent 4 }}
  annotations:
      {{- include "tfy-otel-collector.annotations" . | nindent 4 }}
data:
  config.yaml: |-
    extensions:
      tfyauth: # Custom authorisation
        base_url: https://internal.devtest.truefoundry.tech/api/svc
        cache_ttl: 5m
    receivers:
      otlp:
        protocols:
          http:
            endpoint: 0.0.0.0:4318
            include_metadata: true # Want to maintain the headers. Have to keep include_metada = true
            auth:
              authenticator: tfyauth
    exporters:
      debug:
        verbosity: detailed # For debug. Have to add clickhouse exporter
    processors:
      batch:
        timeout: 5s
        send_batch_size: 5000
      resource: # trace level attributes
        attributes:
          - key: tfytenantid
            from_context: auth.tfytenant
            action: upsert
    service:
      extensions:
        - tfyauth
      pipelines:
        traces:
          receivers: [ otlp ]
          processors: [ resource, batch ]
          exporters: [ debug ]