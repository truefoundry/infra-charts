
{{- if .Values.aws.awsLoadBalancerController.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: aws-load-balancer-controller
  finalizers:
  - resources-finalizer.argocd.argoproj.io
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-16"
  labels:
    truefoundry.com/infra-component: "aws-load-balancer-controller"
spec:
  ignoreDifferences:
    - jqPathExpressions:
        - .data
      kind: Secret
      name: aws-load-balancer-tls
    - jqPathExpressions:
        - .webhooks[]?.clientConfig?.caBundle
      kind: MutatingWebhookConfiguration
      group: admissionregistration.k8s.io
    - jqPathExpressions:
        - .webhooks[]?.clientConfig?.caBundle
      kind: ValidatingWebhookConfiguration
      group: admissionregistration.k8s.io
  destination:
    namespace: aws-load-balancer-controller
    server: 'https://kubernetes.default.svc'
  source:
    repoURL: "https://aws.github.io/eks-charts"
    targetRevision: 1.7.1
    chart: aws-load-balancer-controller
    helm:
      values: |-
        clusterName: {{ .Values.cluster.name }}
        serviceAccount:
          annotations:
            eks.amazonaws.com/role-arn: {{ .Values.aws.awsLoadBalancerController.roleArn }}
  project: tfy-apps
  syncPolicy:
    automated: { }
    syncOptions:
      - RespectIgnoreDifferences=true
      - CreateNamespace=true
      - ServerSideApply=true
{{- end }}