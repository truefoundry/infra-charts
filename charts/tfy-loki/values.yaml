## @section Upstream Loki configurations
##
loki:
  ## @param loki.enabled Enable loki
  enabled: true
  loki:
    rbac:
      namespaced: true
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    schemaConfig:
      configs:
        - from: "2024-04-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: loki_index_
            period: 24h
    storage_config:
      filesystem:
        directory: /tmp/loki/
    pattern_ingester:
        enabled: true
    limits_config:
      allow_structured_metadata: true
      volume_enabled: true
    ruler:
      enable_api: true
    storage:
      type: local
      local:
        directory: /tmp/loki/
    

  lokiCanary:
    enabled: false

  minio:
    enabled: false

  deploymentMode: SingleBinary

  singleBinary:
    replicas: 1

  test:
    enabled: false

  # Zero out replica counts of other deployment modes
  backend:
    replicas: 0
  read:
    replicas: 0
  write:
    replicas: 0
  ingester:
    replicas: 0
  querier:
    replicas: 0
  queryFrontend:
    replicas: 0
  queryScheduler:
    replicas: 0
  distributor:
    replicas: 0
  compactor:
    replicas: 0
  indexGateway:
    replicas: 0
  bloomCompactor:
    replicas: 0
  bloom_gateway:
    enabled: false
  memcached: 
    chunk_cache.enabled: false
  chunksCache:
    enabled: false
  resultsCache:
    enabled: false

promtail:
  ## @param promtail.enabled Enable promtail
  enabled: false
  ## @param promtail.priorityClassName Priority class name for promtail DaemonSet
  priorityClassName: system-node-critical
  config:
    clients:
      ## @param promtail.config.clients[0].url Loki push API URL
      - url: http://loki:3100/loki/api/v1/push
    snippets:
      ## @skip promtail.config.snippets.extraRelabelConfigs
      extraRelabelConfigs:
        - regex: __meta_kubernetes_pod_label_(.+)
          action: labelmap
  ## @param promtail.resources.requests.cpu CPU requests for promtail container
  ## @param promtail.resources.requests.memory Memory requests for promtail container
  ## @param promtail.resources.requests.ephemeral-storage Ephemeral storage requests for promtail container
  ## @param promtail.resources.limits.cpu CPU limits for promtail container
  ## @param promtail.resources.limits.memory Memory limits for promtail container
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
      ephemeral-storage: 256Mi
    limits:
      cpu: 200m
      memory: 1024Mi
  tolerations:
    ## @skip promtail.tolerations[0]
    - key: node-role.kubernetes.io/master
      effect: NoSchedule
      operator: Exists
    ## @skip promtail.tolerations[1]
    - key: node-role.kubernetes.io/control-plane
      effect: NoSchedule
      operator: Exists
    ## @skip promtail.tolerations[2]
    - effect: NoSchedule
      operator: Exists
    ## @skip promtail.tolerations[3]
    - key: CriticalAddonsOnly
      operator: Exists
    ## @skip promtail.tolerations[4]
    - effect: NoExecute
      operator: Exists
alloy:
  enabled: true
  alloy:
    configMap:
      content: |-
        server {
          log_level = "info"
          http_listen_port = 12345
        }

        discovery.kubernetes "pods" {
          role = "pod"
        }

        loki.source.kubernetes "pod_logs" {
          targets    = discovery.kubernetes.pods.targets
          forward_to = [loki.process.k8s_labels.out]
        }

        loki.process "k8s_labels" {
          stage {
            labels {
              values = {
                "namespace" = "namespace",
                "pod"       = "pod_name",
                "container" = "container",
              }
            }
          }
          forward_to = [loki.write.default.out]
        }

        loki.write "default" {
          endpoint {
            url = "http://loki:3100/loki/api/v1/push"
          }
        }
