## @section Upstream Loki configurations
##
loki:
  ## @param loki.enabled Enable loki
  enabled: true
  loki:
    rbac:
      namespaced: true
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    schemaConfig:
      configs:
        - from: "2024-04-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: loki_index_
            period: 24h
    storage_config:
      filesystem:
        directory: /tmp/loki/
    pattern_ingester:
        enabled: true
    limits_config:
      allow_structured_metadata: true
      volume_enabled: true
    ruler:
      enable_api: true
    storage:
      type: local
      local:
        directory: /tmp/loki/
    

  lokiCanary:
    enabled: false

  minio:
    enabled: false

  deploymentMode: SingleBinary

  singleBinary:
    replicas: 1

  test:
    enabled: false

  # Zero out replica counts of other deployment modes
  backend:
    replicas: 0
  read:
    replicas: 0
  write:
    replicas: 0
  ingester:
    replicas: 0
  querier:
    replicas: 0
  queryFrontend:
    replicas: 0
  queryScheduler:
    replicas: 0
  distributor:
    replicas: 0
  compactor:
    replicas: 0
  indexGateway:
    replicas: 0
  bloomCompactor:
    replicas: 0
  bloom_gateway:
    enabled: false
  memcached: 
    chunk_cache.enabled: false
  chunksCache:
    enabled: false
  resultsCache:
    enabled: false

promtail:
  ## @param promtail.enabled Enable promtail
  enabled: false
  ## @param promtail.priorityClassName Priority class name for promtail DaemonSet
  priorityClassName: system-node-critical
  config:
    clients:
      ## @param promtail.config.clients[0].url Loki push API URL
      - url: http://loki:3100/loki/api/v1/push
    snippets:
      ## @skip promtail.config.snippets.extraRelabelConfigs
      extraRelabelConfigs:
        - regex: __meta_kubernetes_pod_label_(.+)
          action: labelmap
  ## @param promtail.resources.requests.cpu CPU requests for promtail container
  ## @param promtail.resources.requests.memory Memory requests for promtail container
  ## @param promtail.resources.requests.ephemeral-storage Ephemeral storage requests for promtail container
  ## @param promtail.resources.limits.cpu CPU limits for promtail container
  ## @param promtail.resources.limits.memory Memory limits for promtail container
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
      ephemeral-storage: 256Mi
    limits:
      cpu: 200m
      memory: 1024Mi
  tolerations:
    ## @skip promtail.tolerations[0]
    - key: node-role.kubernetes.io/master
      effect: NoSchedule
      operator: Exists
    ## @skip promtail.tolerations[1]
    - key: node-role.kubernetes.io/control-plane
      effect: NoSchedule
      operator: Exists
    ## @skip promtail.tolerations[2]
    - effect: NoSchedule
      operator: Exists
    ## @skip promtail.tolerations[3]
    - key: CriticalAddonsOnly
      operator: Exists
    ## @skip promtail.tolerations[4]
    - effect: NoExecute
      operator: Exists
alloy:
  enabled: true
  alloy:
    configMap:
      content: |-
        logging {
          level = "debug"
          format = "logfmt"
        }
        discovery.kubernetes "pods" {
          role = "pod"
        }
        discovery.relabel "pods" {
          targets = discovery.kubernetes.pods.targets

          rule {
            source_labels = ["__meta_kubernetes_namespace", "__meta_kubernetes_pod_label_app_kubernetes_io_name", "__meta_kubernetes_pod_container_name"]
            separator     = "/"
            target_label  = "deployment_name"
            action        = "replace"
          }
        }
        loki.source.kubernetes "pods" {
          targets    = discovery.relabel.pods.output
          forward_to = [loki.process.process.receiver]
        }
        loki.process "process" {
          forward_to = [loki.write.loki.receiver]

          stage.drop {
            older_than          = "1h"
            drop_counter_reason = "too old"
          }
          stage.match { 
            selector = "{instance=~\".*\"}"
            stage.json {
              expressions = {
                level = "level"
              }
            },
            stage.labels {
              values = { 
                level = "level"
              }
            }
          }
          stage.label_drop {
            values = [ "job", "service_name" ]
          }
        }
        loki.write "loki" {
          endpoint {
            url = "http://loki:3100/loki/api/v1/push"
          }
        }
        loki.echo "example" { }
        live_debugging {
          enabled = true
        }
