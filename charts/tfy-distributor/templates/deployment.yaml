# deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-distributor
spec:
  replicas: {{ .Values.distributor.replicaCount | default 1 }}
  selector:
    matchLabels:
      app: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}
    spec:
      containers:
        - name: {{ .Release.Name }}
          image: {{ .Values.distributor.image }}
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: {{ (index .Values.distributor.ports 0).port }}
          env:
            - name: NATS_AUTH_CONFIG
              value: '{"user": "{{ (index .Values.nats.config.merge.authorization.users 0).user }}", "password": "{{ (index .Values.nats.config.merge.authorization.users 0).password }}"}'
            - name: NATS_CONNECTION_CONFIG
              value: '{"servers": "ws://{{ .Release.Name }}-nats:8080", "pingInterval": 5000, "maxPingOut": 3}'
            - name: SERVICE_STREAM_REPLICAS
              value: {{ .Values.distributor.serviceStreamReplicas | quote }}
          resources:
            {{- toYaml .Values.distributor.resources | nindent 12 }}
