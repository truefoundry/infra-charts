{{- if .Values.aws.awsEbsCsiDriver.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: aws-ebs-csi-driver
  finalizers:
  - resources-finalizer.argocd.argoproj.io
  labels:
    truefoundry.com/infra-component: "aws-ebs-csi-driver"
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-weight: "-18"
    helm.sh/resource-policy: {{ .Values.helm.resourcePolicy }}
spec:
  destination:
    namespace: aws-ebs-csi-driver
    server: 'https://kubernetes.default.svc'
  source:
    repoURL: "https://kubernetes-sigs.github.io/aws-ebs-csi-driver"
    targetRevision: 2.54.1
    chart: aws-ebs-csi-driver
    helm:
      values: |-
        {{- if .Values.aws.awsEbsCsiDriver.valuesOverride }}
        {{ .Values.aws.awsEbsCsiDriver.valuesOverride | toYaml | nindent 8 }}
        {{- else }}
        {{- $mergedTolerations := .Values.tolerations }}
        {{- if .Values.aws.awsEbsCsiDriver.tolerations }}
        {{- $mergedTolerations = .Values.aws.awsEbsCsiDriver.tolerations }}
        {{- end }}

        {{- $mergedAffinity := .Values.affinity }}
        {{- if .Values.aws.awsEbsCsiDriver.affinity }}
        {{- $mergedAffinity = .Values.aws.awsEbsCsiDriver.affinity }}
        {{- end }}
        {{- if .Values.registry }}
        image:
          repository: {{ .Values.registry }}/ebs-csi-driver/aws-ebs-csi-driver
        {{- end }}
        {{- range .Values.imagePullSecrets }}
        imagePullSecrets:
          - {{ .name }}
        {{- end }}
        nodeAllocatableUpdatePeriodSeconds: 0
        node:
          tolerateAllTaints: true
          resources:
            requests:
              cpu: 10m
              memory: 40Mi
            limits:
              cpu: 100m
              memory: 400Mi
        sidecars:
          {{- if .Values.registry }}
          resizer:
            image:
              repository: {{ .Values.registry }}/csi-components/csi-resizer
          attacher:
            image:
              repository: {{ .Values.registry }}/csi-components/csi-attacher
          provisioner:
            image:
              repository: {{ .Values.registry }}/csi-components/csi-provisioner
          livenessProbe:
            image:
              repository: {{ .Values.registry }}/csi-components/livenessprobe
          volumemodifier:
            image:
              repository: {{ .Values.registry }}/ebs-csi-driver/volume-modifier-for-k8s
          nodeDriverRegistrar:
            image:
              repository: {{ .Values.registry }}/csi-components/csi-node-driver-registrar
          {{- end }}
          snapshotter:
            {{- if .Values.registry }}
            image:
              repository: {{ .Values.registry }}/csi-components/csi-snapshotter
            {{- end }}
            resources:
              requests:
                cpu: 10m
                memory: 40Mi
              limits:
                cpu: 100m
                memory: 400Mi
        controller:
          enableMetrics: true
          resources:
            requests:
              cpu: 10m
              memory: 40Mi
            limits:
              cpu: 100m
              memory: 400Mi
          serviceMonitor:
            labels:
              release: prometheus
          serviceAccount:
            name: ebs-csi-controller-sa
            annotations:
              eks.amazonaws.com/role-arn: {{ .Values.aws.awsEbsCsiDriver.roleArn }}
          extraVolumeTags:
            cluster-name: "{{ .Values.clusterName }}"
            volume-type: csi-ebs
            truefoundry.com/managed: "true"
          {{- if $mergedTolerations }}
          tolerations:
            {{- toYaml $mergedTolerations | nindent 14 }}
          {{- end }}
          {{- if $mergedAffinity }}
          affinity:
            {{- toYaml $mergedAffinity | nindent 14 }}
          {{- end }}
        storageClasses:
          - name: gp2
            parameters:
              type: gp2
              fsType: ext4
            annotations:
              storageclass.kubernetes.io/is-default-class: "false"
            provisioner: kubernetes.io/aws-ebs
            reclaimPolicy: Delete
            volumeBindingMode: WaitForFirstConsumer
            allowVolumeExpansion: true
          - name: gp3
            parameters:
              type: gp3
              fsType: ext4
              encrypted: "true"
              {{- if .Values.aws.awsEbsCsiDriver.kmsKeyID }}
              kmsKeyId: {{ .Values.aws.awsEbsCsiDriver.kmsKeyID }}
              {{- end }}
            annotations:
              storageclass.kubernetes.io/is-default-class: "true"
            provisioner: ebs.csi.aws.com
            reclaimPolicy: Delete
            volumeBindingMode: WaitForFirstConsumer
            allowVolumeExpansion: true
        {{- end }}
  project: tfy-apps
  syncPolicy:
    automated: {}
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
{{- end }}
