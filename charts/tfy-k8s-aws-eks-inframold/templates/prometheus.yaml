<<<<<<< Updated upstream
{{- if .Values.prometheus.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prometheus
  finalizers:
  - resources-finalizer.argocd.argoproj.io
  labels:
    truefoundry.com/infra-component: "prometheus"
    truefoundry.com/infra-migration-tag: "1000"
spec:
  project: tfy-apps
  destination:
    server: "https://kubernetes.default.svc"
    namespace: prometheus
  syncPolicy:
    automated: {}
    syncOptions:
      - RespectIgnoreDifferences=true
      - CreateNamespace=true
      - ServerSideApply=true
  source:
    repoURL: "https://prometheus-community.github.io/helm-charts"
    targetRevision: 55.8.1
    chart: kube-prometheus-stack
    helm:
      values: |-
        {{- if .Values.prometheus.valuesOverride }}
        {{ .Values.prometheus.valuesOverride | toYaml | nindent 8 }}
        {{- else }}
        defaultRules:
          enabled: false
        coreDns:
          enabled: false
        grafana:
          enabled: false
        kubelet:
          enabled: true
          serviceMonitor:
            probes: false
            metricRelabelings:
              - regex: name
                action: labeldrop
              - regex: metrics_path
                action: labeldrop
              - regex: endpoint
                action: labeldrop
              - regex: instance
                action: labeldrop
              - regex: (container_(.+)|kubelet_volume_(.+))
                action: keep
                sourceLabels:
                  - __name__
            cAdvisorMetricRelabelings:
              - regex: container_blkio_device_usage_total
                action: drop
                sourceLabels:
                  - __name__
              - regex: container_cpu_(load_average_10s|system_seconds_total|user_seconds_total)
                action: drop
                sourceLabels:
                  - __name__
              - regex: container_fs_(io_current|io_time_seconds_total|io_time_weighted_seconds_total|reads_merged_total|sector_reads_total|sector_writes_total|writes_merged_total)
                action: drop
                sourceLabels:
                  - __name__
              - regex: container_memory_(mapped_file|swap)
                action: drop
                sourceLabels:
                  - __name__
              - regex: container_(file_descriptors|tasks_state|threads_max)
                action: drop
                sourceLabels:
                  - __name__
              - regex: container_spec_(cpu_shares|memory_reservation_limit_bytes|memory_swap_limit_bytes)
                action: drop
                sourceLabels:
                  - __name__
              - regex: .+;
                action: drop
                sourceLabels:
                  - id
                  - pod
              - regex: id
                action: labeldrop
              - regex: name
                action: labeldrop
              - regex: metrics_path
                action: labeldrop
              - regex: endpoint
                action: labeldrop
              - regex: instance
                action: labeldrop
        kubeEtcd:
          enabled: false
        kubeProxy:
          enabled: false
        prometheus:
          prometheusSpec:
            resources:
              limits:
                cpu: 2
                memory: 10Gi
              requests:
                cpu: 400m
                memory: 2Gi
            retention: 30d
            storageSpec:
              volumeClaimTemplate:
                spec:
                  resources:
                    requests:
                      storage: 20Gi
                  accessModes:
                    - ReadWriteOnce
            retentionSize: 18GB
            enableAdminAPI: true
            {{- $mergedTolerations := concat .Values.tolerations .Values.prometheus.tolerations }}
            {{- if $mergedTolerations }}
            tolerations:
              {{- toYaml $mergedTolerations | nindent 14 }}
            {{- end }}
            {{- $mergedAffinity := dict | merge .Values.prometheus.affinity .Values.affinity }}
            {{- if $mergedAffinity }}
            affinity:
              {{- toYaml $mergedAffinity | nindent 14 }}
            {{- end }}
            additionalScrapeConfigs:
              - job_name: prometheus
                static_configs:
                  - targets:
                      - localhost:9090
                scrape_interval: 30s
              - scheme: http
                job_name: elasti-resolver
                honor_labels: true
                metrics_path: /metrics
                dns_sd_configs:
                  - port: 8013
                    type: A
                    names:
                      - elasti-resolver-service.elasti
                scrape_interval: 1s
              - scheme: http
                job_name: keda
                honor_labels: true
                metrics_path: /metrics
                dns_sd_configs:
                  - port: 8080
                    type: A
                    names:
                      - keda-operator.keda
                scrape_timeout: 10s
                scrape_interval: 10s
                metric_relabel_configs:
                  - regex: >-
                      (keda_metrics_(.+)|workqueue_(.+)|go_(.+)|controller_(.+)|process_(.+))
                    action: drop
                    source_labels:
                      - __name__
                  - regex: >-
                      (keda_build_info|keda_resource_totals|keda_internal_scale_loop_latency|keda_trigger_totals|keda_scaled_object_errors|keda_scaler_metrics_latency|keda_scaler_errors|keda_scaler_errors_total|keda_scaled_object_errors|keda_scaler_active)
                    action: drop
                    source_labels:
                      - __name__
              - job_name: "envoy-stats"
                kubernetes_sd_configs:
                  - role: pod
                metrics_path: "/stats/prometheus"
                relabel_configs:
                  - regex: .*-envoy-prom
                    action: keep
                    source_labels:
                      - __meta_kubernetes_pod_container_port_name
                  - source_labels: [__meta_kubernetes_pod_name]
                    target_label: pod
                  - source_labels: [__meta_kubernetes_pod_container_name]
                    target_label: container
                  - source_labels: [__meta_kubernetes_namespace]
                    target_label: namespace
                  - source_labels: [__meta_kubernetes_pod_node_name]
                    action: replace
                    target_label: node
                metric_relabel_configs:
                  - source_labels: [ __name__ ]
                    action: drop
                    regex: envoy_(.+)
                  - source_labels: [ __name__ ]
                    action: drop
                    regex: (istio_response_bytes_bucket|istio_request_bytes_bucket|istio_request_bytes_count|istio_response_bytes_count)
              - job_name: "kubernetes-pods"
                kubernetes_sd_configs:
                  - role: pod
                relabel_configs:
                  - action: drop
                    source_labels: [__meta_kubernetes_namespace]
                    regex: (istio-system|cert-manager|kube-system)
                  - action: drop
                    source_labels: [__meta_kubernetes_pod_container_init]
                    regex: true
                  - source_labels:
                      [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                    action: keep
                    regex: true
                  - source_labels:
                      [__meta_kubernetes_pod_annotation_prometheus_io_scheme]
                    action: replace
                    target_label: __scheme__
                    regex: (https?)
                  - source_labels:
                      [__meta_kubernetes_pod_annotation_prometheus_io_path]
                    action: replace
                    target_label: __metrics_path__
                    regex: (.+)
                  - source_labels:
                      [
                        __address__,
                        __meta_kubernetes_pod_annotation_prometheus_io_port,
                      ]
                    action: replace
                    target_label: __address__
                    regex: ([^:]+)(?::\d+)?;(\d+)
                    replacement: $1:$2
                  - source_labels: [__meta_kubernetes_pod_name]
                    target_label: pod
                  - source_labels: [__meta_kubernetes_pod_container_name]
                    target_label: container
                  - source_labels: [__meta_kubernetes_namespace]
                    target_label: namespace
                  - source_labels: [__meta_kubernetes_pod_node_name]
                    action: replace
                    target_label: node
                  - target_label: label_truefoundry_com_application_id
                    source_labels:
                      - __meta_kubernetes_pod_label_truefoundry_com_application_id
              - job_name: argo-workflows
                static_configs:
                  - targets:
                      - argo-workflows-workflow-controller.argo-workflows.svc.cluster.local:8080
              - scheme: http
                job_name: kubecost
                honor_labels: true
                metrics_path: /metrics
                dns_sd_configs:
                  - port: 9003
                    type: A
                    names:
                      - kubecost-cost-analyzer.kubecost
                scrape_timeout: 60s
                scrape_interval: 1m
              - scheme: http
                job_name: loki
                honor_labels: true
                metrics_path: /metrics
                dns_sd_configs:
                  - port: 3100
                    type: A
                    names:
                      - loki.loki
              - scheme: http
                job_name: loki-promtail
                honor_labels: true
                metrics_path: /metrics
                dns_sd_configs:
                  - port: 3101
                    type: A
                    names:
                      - loki-promtail-metrics.loki
=======
additionalScrapeConfigs:
  - job_name: prometheus
    static_configs:
      - targets:
          - localhost:9090
    scrape_interval: 30s
  - scheme: http
    job_name: elasti-resolver
    honor_labels: true
    metrics_path: /metrics
    dns_sd_configs:
      - port: 8013
        type: A
        names:
          - elasti-resolver-service.elasti
    scrape_interval: 1s
  - scheme: http
    job_name: keda
    honor_labels: true
    metrics_path: /metrics
    dns_sd_configs:
      - port: 8080
        type: A
        names:
          - keda-operator.keda
    scrape_timeout: 10s
    scrape_interval: 10s
    metric_relabel_configs:
      - regex: >-
          (keda_metrics_(.+)|workqueue_(.+)|go_(.+)|controller_(.+)|process_(.+))
        action: drop
        source_labels:
          - __name__
      - regex: >-
          (keda_build_info|keda_resource_totals|keda_internal_scale_loop_latency|keda_trigger_totals|keda_scaled_object_errors|keda_scaler_metrics_latency|keda_scaler_errors|keda_scaler_errors_total|keda_scaled_object_errors|keda_scaler_active)
        action: drop
        source_labels:
          - __name__
  - job_name: "envoy-stats"
    kubernetes_sd_configs:
      - role: pod
    metrics_path: "/stats/prometheus"
    relabel_configs:
      - regex: .*-envoy-prom
        action: keep
        source_labels:
          - __meta_kubernetes_pod_container_port_name
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod
      - source_labels: [__meta_kubernetes_pod_container_name]
        target_label: container
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace
      - source_labels: [__meta_kubernetes_pod_node_name]
        action: replace
        target_label: node
    metric_relabel_configs:
      - source_labels: [ __name__ ]
        action: drop
        regex: envoy_(.+)
      - source_labels: [ __name__ ]
        action: drop
        regex: (istio_response_bytes_bucket|istio_request_bytes_bucket|istio_request_bytes_count|istio_response_bytes_count)
  - job_name: "kubernetes-pods"
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - action: drop
        source_labels: [__meta_kubernetes_namespace]
        regex: (istio-system|cert-manager|kube-system)
      - action: drop
        source_labels: [__meta_kubernetes_pod_container_init]
        regex: true
      - source_labels:
          [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels:
          [__meta_kubernetes_pod_annotation_prometheus_io_scheme]
        action: replace
        target_label: __scheme__
        regex: (https?)
      - source_labels:
          [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels:
          [
            __address__,
            __meta_kubernetes_pod_annotation_prometheus_io_port,
          ]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod
      - source_labels: [__meta_kubernetes_pod_container_name]
        target_label: container
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace
      - source_labels: [__meta_kubernetes_pod_node_name]
        action: replace
        target_label: node
      - target_label: label_truefoundry_com_application_id
        source_labels:
          - __meta_kubernetes_pod_label_truefoundry_com_application_id
  - job_name: argo-workflows
    static_configs:
      - targets:
          - argo-workflows-workflow-controller.argo-workflows.svc.cluster.local:8080
  - scheme: http
    job_name: kubecost
    honor_labels: true
    metrics_path: /metrics
    dns_sd_configs:
      - port: 9003
        type: A
        names:
          - kubecost-cost-analyzer.kubecost
    scrape_timeout: 60s
    scrape_interval: 1m
  - scheme: http
    job_name: loki
    honor_labels: true
    metrics_path: /metrics
    dns_sd_configs:
      - port: 3100
        type: A
        names:
          - loki.loki
  - scheme: http
    job_name: loki-promtail
    honor_labels: true
    metrics_path: /metrics
    dns_sd_configs:
      - port: 3101
        type: A
        names:
          - loki-promtail-metrics.loki
>>>>>>> Stashed changes
              {{- with .Values.prometheus.additionalScrapeConfigs }}
              {{ toYaml . | nindent 14 }}
              {{- end }}