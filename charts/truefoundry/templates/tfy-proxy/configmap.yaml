{{- if and .Values.tfyProxy.enabled (not .Values.tfyProxy.existingProxyConfigMapName) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tfy-proxy.fullname" . }}
  labels:
    {{- include "tfy-proxy.commonLabels" . | nindent 4 }}
  annotations:
    {{- include "tfy-proxy.commonAnnotations" . | nindent 4 }}
data:
  {{- if .Values.tfyProxy.proxyConfigOverride }}
  nginx.conf: |-
    {{ .Values.tfyProxy.proxyConfigOverride | nindent 4 }}
  {{- else }}
  nginx.conf: |
    events {
      worker_connections 1024;
    }

    http {
      include       /etc/nginx/mime.types;

      client_body_temp_path  /var/cache/nginx/client_temp;
      proxy_temp_path        /var/cache/nginx/proxy_temp;
      fastcgi_temp_path      /var/cache/nginx/fastcgi_temp;
      uwsgi_temp_path        /var/cache/nginx/uwsgi_temp;
      scgi_temp_path         /var/cache/nginx/scgi_temp;

      access_log /var/log/nginx/access.log;
      error_log /var/log/nginx/error.log debug;

      # Define once, used by WS/SSE locations
      map $http_upgrade $connection_upgrade {
        default upgrade;
        ""      close;
      }

      # Define once, used by WS locations
      map $http_upgrade $is_ws {
        default 0;
        ~*websocket 1;
        ~*upgrade 1;
        ""      0;
      }

      server {
        listen 8080;
        server_name {{ if .Values.global.proxy.hosts }}{{ join " " .Values.global.proxy.hosts }}{{ else }}{{ .Values.global.controlPlaneURL }}{{ end }};

        root /usr/share/nginx/html;
        index index.html;

        gzip on;
        gzip_disable "msie6";
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_min_length 256;
        gzip_types
          application/atom+xml
          application/geo+json
          application/javascript
          application/x-javascript
          application/json
          application/ld+json
          application/manifest+json
          application/rdf+xml
          application/rss+xml
          application/xhtml+xml
          application/xml
          font/eot
          font/otf
          font/ttf
          image/svg+xml
          text/css
          text/javascript
          text/plain
          text/xml;

        client_max_body_size 0;
        # simple health endpoint
        location = /health { return 200; }

        {{- if .Values.servicefoundryServer.enabled }}
        # WebSocket proxy for socket.io
        location ~* ^/api/svc/socket\.io(?:/|$) {
          rewrite ^/api/svc/socket\.io/?(.*)$ /socket.io/$1 break;

          proxy_pass http://{{ tpl .Values.global.proxy.servicefoundryServerHost . }}:{{ .Values.servicefoundryServer.service.port }};

          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_connect_timeout 60s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;

          proxy_buffering off;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }

        location ~* ^/api/svc(?:/|$) {
          rewrite ^/api/svc/(.*)$ /$1 break;
          proxy_pass http://{{ tpl .Values.global.proxy.servicefoundryServerHost . }}:{{ .Values.servicefoundryServer.service.port }};

          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_connect_timeout 60s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;

          proxy_buffering off;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.sfyManifestService.enabled }}
        # SFY Manifest Service
        location ~* ^/api/manifest(?:/|$) {
          rewrite ^/api/manifest/?(.*)$ /$1 break;

          proxy_pass http://{{ tpl .Values.global.proxy.sfyManifestServiceHost . }}:{{ .Values.sfyManifestService.service.port }};



          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Port $server_port;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_connect_timeout 60s;
          proxy_send_timeout 60s;
          proxy_read_timeout 3600s;

          proxy_buffering off;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_cache_bypass $http_upgrade;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.mlfoundryServer.enabled }}
        # MLFoundry Server
        location ~* ^/api/ml(?:/|$) {
          rewrite ^/api/ml/?(.*)$ /$1 break;

          proxy_pass http://{{ tpl .Values.global.proxy.mlfoundryHost . }}:{{ .Values.mlfoundryServer.service.port }};



          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_connect_timeout 60s;
          proxy_read_timeout 60s;
          proxy_send_timeout 3600s;

          proxy_buffering off;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.tags.llmGateway }}
        # LLM Gateway (long-lived streams)
        location ~* ^/api/llm(?:/|$) {
          rewrite ^/api/llm/?(.*)$ /$1 break;

          proxy_pass http://{{ tpl .Values.global.proxy.llmGateway.backendHost . }}:{{ .Values.global.proxy.llmGateway.backendPort }};

          gzip off;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Port $server_port;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_connect_timeout 60s;
          proxy_send_timeout 3600s;
          proxy_read_timeout 60s;

          proxy_buffering off;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_cache_bypass $http_upgrade;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.tfyProxy.enabled }}
        # Controller
        location ~* ^/api/proxy-server(?:/|$) {
          rewrite ^/api/proxy-server/?(.*)$ /$1 break;

          proxy_pass http://{{ tpl .Values.global.proxy.proxyServerHost . }}:{{ .Values.tfyController.service.port }};



          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          proxy_set_header Sec-WebSocket-Protocol $http_sec_websocket_protocol;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Port $server_port;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_connect_timeout 60s;
          proxy_send_timeout 3600s;
          proxy_read_timeout 3600s;

          proxy_buffering off;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_cache_bypass $http_upgrade;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.tfyWorkflowAdmin.enabled }}
        # Flyte Admin gRPC (no rewrite, keep method path intact)
        location ~* ^/flyteidl\.service\.AdminService(?:/|$) {
          grpc_pass grpc://{{ tpl .Values.global.proxy.tfyWorkflowAdminHost . }}:{{ .Values.tfyWorkflowAdmin.service.port }};

          grpc_read_timeout  3600s;
          grpc_send_timeout  3600s;

          grpc_set_header Host $host;
          grpc_set_header X-Real-IP $remote_addr;
          grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          grpc_set_header X-Forwarded-Proto $scheme;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.s3proxy.enabled }}
        # S3 proxy (streaming uploads)
        location ~* ^/api/s3proxy(?:/|$) {
          rewrite ^/api/s3proxy/?(.*)$ /$1 break;

          proxy_pass http://{{ tpl .Values.global.proxy.s3proxyHost . }}:{{ .Values.s3proxy.service.port }};



          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Port $server_port;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_request_buffering off;    # stream to upstream

          proxy_connect_timeout 60s;
          proxy_send_timeout 60s;
          proxy_read_timeout 300s;

          proxy_buffering off;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_cache_bypass $http_upgrade;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.tags.tracing }}
        # OpenTelemetry Collector (OTLP/HTTP on :4318) strip /api/otel
        location ~* ^/api/otel(?:/|$) {
          rewrite ^/api/otel/?(.*)$ /$1 break;

          proxy_pass http://{{ tpl .Values.global.proxy.tfyOtelCollector.host . }}:{{ .Values.global.proxy.tfyOtelCollector.port }};

          proxy_http_version 1.1;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Port $server_port;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_connect_timeout 60s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;

          proxy_buffering off;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.tfyProxy.extraProxyLocations }}
        {{- range $idx, $proxyLocation := .Values.tfyProxy.extraProxyLocations }}
        {{ $proxyLocation | nindent 8 }}
        {{- end }}
        {{- end }}

        # Frontend assets
        location ^~ /assets/ {
          try_files $uri =404;
          access_log off;
        }

        # SPA catch-all with WS handoff via named location
        location / {
        # If it's a WS handshake, internally jump to @nats_ws
        error_page 418 = @nats_ws;
        if ($is_ws) { return 418; }   # only 'return' inside if -> allowed

        # Normal HTTP deep links -> SPA
        try_files $uri $uri/ /index.html;
      }

      # All proxy_* live here (legal context)
        location @nats_ws {
          proxy_pass http://{{ tpl .Values.global.proxy.tfyNats.host . }}:{{ .Values.global.proxy.tfyNats.port }};

          proxy_http_version 1.1;

          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          proxy_set_header Host $host;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_read_timeout 86400;
          proxy_send_timeout 86400;
          proxy_connect_timeout 60s;

          proxy_buffering off;
          proxy_request_buffering off;
        }
      }
      # NGINX stub status for monitoring
      server {
        listen 127.0.0.1:8081;
        server_name 127.0.0.1;

        location /stub_status {
        stub_status;         # built-in NGINX status
        allow 127.0.0.1;     # exporter only
        deny all;
        }
      }
    }
  {{- end }}
{{- end -}}