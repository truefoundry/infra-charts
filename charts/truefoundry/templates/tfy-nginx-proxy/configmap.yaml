{{- if .Values.tfyNginxProxy.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tfy-nginx-proxy.fullname" . }}
  labels:
    {{- include "tfy-nginx-proxy.labels" . | nindent 4 }}
  annotations:
    {{- include "tfy-nginx-proxy.annotations" . | nindent 4 }}
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }

    http {
      client_body_temp_path  /var/cache/nginx/client_temp;
      proxy_temp_path        /var/cache/nginx/proxy_temp;
      fastcgi_temp_path      /var/cache/nginx/fastcgi_temp;
      uwsgi_temp_path        /var/cache/nginx/uwsgi_temp;
      scgi_temp_path         /var/cache/nginx/scgi_temp;

      # Define once, used by WS/SSE locations
      map $http_upgrade $connection_upgrade {
        default upgrade;
        ""      close;
      }

      server {
        listen 8080;
        server_name {{ if .Values.global.proxy.hosts }}{{ join " " .Values.global.proxy.hosts }}{{ else }}{{ .Values.global.controlPlaneURL }}{{ end }};
        include       /etc/nginx/mime.types;

        gzip on;
        gzip_disable "msie6";
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_min_length 256;
        gzip_types
          application/atom+xml
          application/geo+json
          application/javascript
          application/x-javascript
          application/json
          application/ld+json
          application/manifest+json
          application/rdf+xml
          application/rss+xml
          application/xhtml+xml
          application/xml
          font/eot
          font/otf
          font/ttf
          image/svg+xml
          text/css
          text/javascript
          text/plain
          text/xml;

        client_max_body_size 0;
        # simple health endpoint
        location = /health { return 200; }

        {{- if .Values.servicefoundryServer.enabled }}
        # WebSocket proxy for socket.io
        location ~* ^/api/svc/socket\.io(?:/|$) {
          rewrite ^/api/svc/socket\.io/?(.*)$ /socket.io/$1 break;
          proxy_pass http://{{ tpl .Values.truefoundryFrontendApp.servicefoundryServerHost . }}:{{ .Values.servicefoundryServer.service.port }};

          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_connect_timeout 5s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;

          proxy_buffering off;
          proxy_buffer_size 4k;
          proxy_buffers 4 4k;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }

        location /api/svc/v1/tfy-ai/proxy {
          rewrite ^/api/svc/(.*)$ /$1 break;
          proxy_pass http://truefoundry-servicefoundry-server.truefoundry.svc.cluster.local:3000;

          gzip off;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Proto $scheme;

          client_max_body_size 0;
          proxy_connect_timeout 5s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;

          proxy_buffering off;
          proxy_buffer_size 4k;
          proxy_buffers 4 4k;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }

        location /api/svc/ {
          rewrite ^/api/svc/(.*)$ /$1 break;
          proxy_pass http://{{ tpl .Values.truefoundryFrontendApp.servicefoundryServerHost . }}:{{ .Values.servicefoundryServer.service.port }};

          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_connect_timeout 5s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;

          proxy_buffering off;
          proxy_buffer_size 4k;
          proxy_buffers 4 4k;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.mlfoundryServer.enabled }}
        # MLFoundry Server
        location ~* ^/api/ml(?:/|$) {
          rewrite ^/api/ml/?(.*)$ /$1 break;
          proxy_pass http://{{ tpl .Values.truefoundryFrontendApp.mlfoundryHost . }}:{{ .Values.mlfoundryServer.service.port }};

          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_connect_timeout 5s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;

          proxy_buffering off;
          proxy_buffer_size 4k;
          proxy_buffers 4 4k;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.tags.llmGateway }}
        # LLM Gateway (long-lived streams)
        location ~* ^/api/llm(?:/|$) {
          rewrite ^/api/llm/?(.*)$ /$1 break;
          proxy_pass http://{{ tpl .Values.truefoundryFrontendApp.llmGateway.backendHost . }}:{{ .Values.truefoundryFrontendApp.llmGateway.backendPort }};

          gzip off;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          proxy_read_timeout 3600s;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Port $server_port;
          proxy_set_header X-Forwarded-Proto $scheme;

          client_max_body_size 0;
          proxy_connect_timeout 5s;
          proxy_send_timeout 60s;

          proxy_buffering off;
          proxy_buffer_size 4k;
          proxy_buffers 4 4k;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_cache_bypass $http_upgrade;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.tfyNginxProxy.enabled }}
        # Controller
        location ~* ^/api/proxy-server(?:/|$) {
          rewrite ^/api/proxy-server/?(.*)$ /$1 break;
          proxy_pass http://{{ tpl .Values.truefoundryFrontendApp.proxyServerHost . }}:{{ .Values.tfyNginxProxy.service.port }};

          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Port $server_port;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_connect_timeout 5s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;

          proxy_buffering off;
          proxy_buffer_size 4k;
          proxy_buffers 4 4k;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_cache_bypass $http_upgrade;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.tfyWorkflowAdmin.enabled }}
        # Flyte Admin gRPC (no rewrite, keep method path intact)
        location ~* ^/flyteidl\.service\.AdminService(?:/|$) {
          grpc_pass grpc://{{ tpl .Values.truefoundryFrontendApp.tfyWorkflowAdminHost . }}:{{ .Values.tfyWorkflowAdmin.service.port }};

          grpc_read_timeout  3600s;
          grpc_send_timeout  3600s;

          grpc_set_header Host $host;
          grpc_set_header X-Real-IP $remote_addr;
          grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          grpc_set_header X-Forwarded-Proto $scheme;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.s3proxy.enabled }}
        # S3 proxy (streaming uploads)
        location ~* ^/api/s3proxy(?:/|$) {
          rewrite ^/api/s3proxy/?(.*)$ /$1 break;
          proxy_pass http://{{ tpl .Values.truefoundryFrontendApp.s3proxyHost . }}:{{ .Values.s3proxy.service.port }};

          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Port $server_port;
          proxy_set_header X-Forwarded-Proto $scheme;

          client_max_body_size 0;        # raise for large uploads
          proxy_request_buffering off;    # stream to upstream
          proxy_connect_timeout 5s;
          proxy_send_timeout 60s;
          proxy_read_timeout 300s;

          proxy_buffering off;
          proxy_buffer_size 4k;
          proxy_buffers 4 4k;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_cache_bypass $http_upgrade;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.tags.tracing }}
        # OpenTelemetry Collector (OTLP/HTTP on :4318) strip /api/otel
        location ~* ^/api/otel(?:/|$) {
          rewrite ^/api/otel/?(.*)$ /$1 break;
          proxy_pass http://{{ tpl .Values.truefoundryFrontendApp.tfyOtelCollectorHost . }}:4318;

          proxy_http_version 1.1;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Port $server_port;
          proxy_set_header X-Forwarded-Proto $scheme;

          client_max_body_size 0;
          proxy_connect_timeout 5s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;

          proxy_buffering off;
          proxy_buffer_size 8k;
          proxy_buffers 8 8k;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_redirect off;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
        {{- end }}

        {{- if .Values.tfyNginxProxy.extraProxyLocations }}
        {{- range $idx, $proxyLocation := .Values.tfyNginxProxy.extraProxyLocations }}
        {{ $proxyLocation | nindent 8 }}
        {{- end }}
        {{- end }}

        # Frontend assets
        location /assets/ {
          root /usr/share/nginx/html;
          try_files $uri /index.html;
          access_log off;
        }

        # Frontend catch-all
        location / {
          proxy_pass http://truefoundry-truefoundry-frontend-app.{{ .Release.Namespace }}.svc.cluster.local:5000;

          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Port $server_port;
          proxy_set_header X-Forwarded-Proto $scheme;

          client_max_body_size 1m;
          proxy_connect_timeout 5s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;

          proxy_buffering off;
          proxy_buffer_size 4k;
          proxy_buffers 4 4k;

          proxy_cookie_domain off;
          proxy_cookie_path off;
          proxy_redirect off;
          proxy_cache_bypass $http_upgrade;

          proxy_next_upstream error timeout;
          proxy_next_upstream_timeout 0;
          proxy_next_upstream_tries 3;
        }
      }
    }
{{- end -}}